<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimisation VRP - Interface Web</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        
        #main-container {
            position: relative;
            width: 100%;
            height: 100vh;
        }
        
        #page-header {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1004;
            text-align: center;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: left 0.3s ease, transform 0.3s ease;
        }
        
        body.sidebar-collapsed #page-header {
            left: 50%;
            transform: translateX(-50%);
        }
        
        body:not(.sidebar-collapsed) #page-header {
            left: calc(50% - 210px);
            transform: translateX(-50%);
        }
        
        #page-title-box {
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        #page-title {
            font-size: 32px;
            font-weight: bold;
            color: #000;
            margin: 0;
        }
        
        #page-subtitle-box {
            background: white;
            padding: 10px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            width: fit-content;
            margin: 0 auto;
        }
        
        #page-subtitle {
            font-size: 14px;
            color: #000;
            margin: 0;
            font-weight: normal;
        }
        
        #sidebar {
            position: fixed;
            right: 0;
            top: 0;
            width: 420px;
            height: 100vh;
            background: #f5f5f5;
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid #ddd;
            z-index: 1000;
            transition: transform 0.3s ease;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
        }
        
        #sidebar.collapsed {
            transform: translateX(100%);
        }
        
        #sidebar-toggle {
            position: fixed;
            right: 420px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: #000;
            color: white;
            border: none;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            z-index: 1003;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -2px 2px 8px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
        }
        
        #sidebar-toggle:hover {
            background: #333;
        }
        
        #sidebar.collapsed + #sidebar-toggle {
            right: 0;
        }
        
        #bottom-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 420px;
            background: white;
            padding: 15px 20px;
            border-top: 2px solid #ddd;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.2);
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            transition: right 0.3s ease;
        }
        
        #bottom-buttons-logo {
            position: absolute;
            left: 20px;
            height: 65px;
            margin-bottom: 5px;
            flex-shrink: 0;
        }
        
        #bottom-buttons-content {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }
        
        body.sidebar-collapsed #bottom-buttons {
            right: 0;
        }
        
        #bottom-buttons button {
            width: auto;
            min-width: 150px;
            margin: 0;
        }
        
        #mode-raisonnement-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 15px;
            position: relative;
        }
        
        #mode-raisonnement-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        #mode-raisonnement {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            min-width: 200px;
        }
        
        
        #solve-btn {
            position: relative;
            overflow: hidden;
            min-width: 150px;
            height: auto;
            padding: 10px 20px;
            background: #000;
            color: white;
        }
        
        #solve-btn:hover {
            background: #333;
        }
        
        #solve-btn.progress-mode {
            min-width: 150px;
            padding: 10px 20px;
            height: auto;
            background: #e0e0e0;
            border: 2px solid #000;
        }
        
        #solve-btn .progress-fill-btn {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, #000, #333);
            width: 0%;
            transition: width 0.3s;
            z-index: 1;
        }
        
        #solve-btn .progress-text-btn {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-size: 12px;
            padding: 0 10px;
            text-align: center;
            pointer-events: none;
        }
        
        #solve-btn.progress-mode .progress-text-btn {
            color: #666;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }
        
        h2 {
            font-size: 18px;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #555;
        }
        
        .section {
            margin-bottom: 15px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            margin-bottom: 10px;
        }
        
        .section-header:hover {
            opacity: 0.8;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .section-toggle {
            font-size: 14px;
            color: #666;
            transition: transform 0.2s;
            margin-left: 10px;
        }
        
        .section.collapsed .section-toggle {
            transform: rotate(-90deg);
        }
        
        .section-content {
            max-height: 2000px;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out;
            overflow: hidden;
        }
        
        .section.collapsed .section-content {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }
        
        .subsection {
            margin-top: 12px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }
        
        .subsection-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 8px 0;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        .subsection-header:hover {
            color: #4CAF50;
        }
        
        .subsection-content {
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .subsection.collapsed .subsection-content {
            display: none;
        }
        
        .subsection-toggle {
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .subsection.collapsed .subsection-toggle {
            transform: rotate(-90deg);
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #666;
            font-size: 13px;
        }
        
        .config-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .config-row label {
            flex: 0 0 80px;
            margin: 0;
            font-size: 12px;
            font-weight: normal;
        }
        
        .config-row input {
            flex: 1;
            margin: 0;
        }
        
        input, select {
            width: 100%;
            padding: 7px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .compact-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .compact-list-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .compact-list-item label {
            flex: 0 0 70px;
            margin: 0;
            font-size: 11px;
            color: #888;
        }
        
        .compact-list-item input {
            flex: 1;
            margin: 0;
            padding: 5px;
            font-size: 12px;
        }
        
        .compact-list-item select {
            flex: 0 0 100px;
            margin: 0 0 0 5px;
            padding: 5px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .vehicules-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .vehicules-table thead {
            background: #f0f0f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .vehicules-table th {
            padding: 8px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #ddd;
            font-size: 11px;
        }
        
        .vehicules-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .vehicules-table tbody tr:hover {
            background: #f9f9f9;
        }
        
        .vehicules-table input,
        .vehicules-table select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .vehicules-table-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        
        .compact-list-item select {
            margin: 0;
            padding: 5px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: 600;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #2196F3;
        }
        
        .btn-secondary:hover {
            background: #0b7dda;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 10px;
            background: #e0e0e0;
            border: 2px solid transparent;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        /* couleur d√©p√¥t (rouge) quand actif */
        #mode-depot.active {
            background: #f44336;
            color: white;
            border-color: #d32f2f;
        }
        
        /* couleur client (bleu) quand actif */
        #mode-client.active {
            background: #2196F3;
            color: white;
            border-color: #1976d2;
        }
        
        /* couleur station (vert) quand actif */
        #mode-station.active {
            background: #4CAF50;
            color: white;
            border-color: #388e3c;
        }
        
        .info-box {
            margin-top: 15px;
            padding: 10px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        #results-section {
            position: fixed;
            bottom: 120px;
            left: 20px;
            z-index: 1001;
            max-width: 400px;
            width: 400px;
        }
        
        body.sidebar-collapsed #results-section {
            left: 20px;
        }
        
        .results {
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            border-left: 4px solid #000;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .results h3 {
            margin-bottom: 8px;
            color: #fff;
            margin-top: 0;
            font-size: 16px;
        }
        
        .results p {
            margin: 4px 0;
            color: #fff;
            font-size: 13px;
        }
        
        .point-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .point-item {
            padding: 8px;
            margin: 5px 0;
            background: #f9f9f9;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .point-item-content {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .point-item-btn {
            padding: 2px;
            background: transparent;
            color: #f44336;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            width: 20px;
            height: 20px;
        }
        
        .point-item-btn:hover {
            background: #ffebee;
            color: #d32f2f;
            transform: scale(1.1);
        }
        
        .clear-points-btn {
            width: 100%;
            padding: 8px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .clear-points-btn:hover {
            background: #d32f2f;
        }
        
        /* contr√¥les leaflet au premier plan */
        .leaflet-control-container {
            z-index: 1003 !important;
        }
        
        .leaflet-control {
            z-index: 1003 !important;
        }
        
        .leaflet-top,
        .leaflet-bottom {
            z-index: 1003 !important;
        }
        
        /* repositionner les cr√©dits leaflet selon l'√©tat de la sidebar */
        .leaflet-control-attribution {
            transition: right 0.3s ease;
        }
        
        body.sidebar-collapsed .leaflet-control-attribution {
            right: 10px;
        }
        
        body:not(.sidebar-collapsed) .leaflet-control-attribution {
            right: 430px;
        }
    </style>
</head>
<body>
    <div id="sidebar" class="collapsed">
            <h1>‚öôÔ∏è‚Äã Panneau de configuration</h1>
            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2>üìç‚Äã Mode de placement</h2>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="mode-selector">
                        <div class="mode-btn active" id="mode-depot" onclick="setMode('depot')">D√©p√¥t</div>
                        <div class="mode-btn" id="mode-client" onclick="setMode('client')">Client</div>
                        <div class="mode-btn" id="mode-station" onclick="setMode('station')">Station</div>
                    </div>
                    <p id="mode-description" style="font-size: 12px; color: #666; margin-top: 10px;">
                        Mode s√©lectionn√© : D√©p√¥t - Cliquez sur la carte pour placer un d√©p√¥t
                    </p>
                    
                    <div style="margin-top: 12px;">
                        <label style="font-size: 11px; font-weight: 500; color: #666; display: block; margin-bottom: 5px;">
                            Rechercher une adresse:
                        </label>
                        <input type="text" id="address-search" placeholder="Ex: 10 rue de la Paix, Paris" onkeypress="if(event.key==='Enter') searchAddress()" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-bottom: 6px;">
                        <button onclick="searchAddress()" style="width: 100%; padding: 6px; background: #000; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            Rechercher
                        </button>
                        <p id="address-status" style="font-size: 10px; color: #999; margin-top: 4px; margin-bottom: 0;"></p>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2>üöö V√©hicule</h2>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="config-row">
                        <label>Nombre :</label>
                        <input type="number" id="nb-vehicules" value="2" min="1" max="10" onchange="updateCapacitesVehicules()" style="margin-bottom: 0;">
                    </div>
                    
                    <div class="config-row">
                        <label>Type:</label>
                        <select id="type-vrp" onchange="toggleAutonomieColumn()" style="margin-bottom: 0;">
                            <option value="classique">Classique</option>
                            <option value="vert">Vert (√âlectrique)</option>
                        </select>
                    </div>
                    
                    <p style="font-size: 11px; color: #666; margin-bottom: 8px;">
                        Capacit√© de chaque v√©hicule (en unit√©s):
                    </p>
                    <div class="vehicules-table-container">
                        <table class="vehicules-table" id="capacites-vehicules">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">V√©hicule</th>
                                    <th style="width: 35%;">Capacit√© (en unit√©s)</th>
                                    <th class="autonomie-col" style="width: 35%; display: none;">Autonomie (km)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>V√©hicule 1</td>
                                    <td>
                                        <input type="number" class="capacite-vehicule" value="50" min="1">
                                    </td>
                                    <td class="autonomie-col" style="display: none;">
                                        <input type="number" class="autonomie-vehicule" value="30" min="1" step="0.1">
                                    </td>
                                </tr>
                                <tr>
                                    <td>V√©hicule 2</td>
                                    <td>
                                        <input type="number" class="capacite-vehicule" value="50" min="1">
                                    </td>
                                    <td class="autonomie-col" style="display: none;">
                                        <input type="number" class="autonomie-vehicule" value="30" min="1" step="0.1">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2>üë• Client</h2>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <p style="font-size: 12px; color: #666; margin-bottom: 8px;">
                        Taille du colis (en unit√©s) pour chaque client :
                    </p>
                    <div class="vehicules-table-container" id="demandes-clients">
                        <p style="color: #999; font-size: 11px; text-align: center; padding: 10px;">
                            Placez d'abord les clients sur la carte
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h2>üß≠ Points plac√©s</h2>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <button onclick="clearAll()" class="clear-points-btn">Supprimer tout</button>
                    <div id="points-list">
                        <p style="color: #999; font-size: 12px;">Aucun point plac√©</p>
                    </div>
                </div>
            </div>
    </div>
    
    <button id="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
    
    <div id="page-header">
        <div id="page-title-box">
            <h1 id="page-title">Optimisation de tourn√©es de livraison</h1>
        </div>
        <div id="page-subtitle-box">
            <p id="page-subtitle">Par Gr√©goire BRUN, Cl√©ment CARON et Alexis DHERMY</p>
        </div>
    </div>
    
    <div id="main-container">
        <div id="map"></div>
        <div id="results-section" style="display: none;">
            <div class="results">
                <h3>R√©sultats</h3>
                <p id="result-statut"></p>
                <p id="result-distance"></p>
                <p id="result-vehicules"></p>
            </div>
        </div>
    </div>
    
    <div id="bottom-buttons">
        <img id="bottom-buttons-logo" src="{{ url_for('static', filename='images/EPF Logo + Baseline Noir.png') }}" alt="EPF Logo">
        <div id="bottom-buttons-content">
            <div id="mode-raisonnement-container">
                <label id="mode-raisonnement-label">Mode de raisonnement</label>
                <select id="mode-raisonnement" onchange="updateModeRaisonnementDescription()">
                    <option value="rapide">Rapide</option>
                    <option value="normal" selected>Normal</option>
                    <option value="exploratoire">Exploratoire</option>
                </select>
            </div>
            <button onclick="solveVRP()" id="solve-btn">R√©soudre</button>
            <button onclick="cancelSolution()" id="cancel-btn" class="btn-danger" style="display: none;">Annuler</button>
        </div>
    </div>
    
    <script>
        // fonction pour plier/d√©plier la sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebar-toggle');
            const isCollapsed = sidebar.classList.contains('collapsed');
            
            sidebar.classList.toggle('collapsed');
            document.body.classList.toggle('sidebar-collapsed', !isCollapsed);
            toggle.textContent = sidebar.classList.contains('collapsed') ? '‚ò∞' : '‚úï';
            
            // redimensionner la carte apr√®s l'animation
            setTimeout(() => {
                map.invalidateSize();
            }, 300);
        }
        
        // fonction pour plier/d√©plier les sections
        function toggleSection(header) {
            const section = header.closest('.section');
            section.classList.toggle('collapsed');
        }
        
        // initialisation de la carte
        const map = L.map('map').setView([48.8566, 2.3522], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // ajouter la l√©gende d'√©chelle
        L.control.scale({
            metric: true,
            imperial: false,
            position: 'topleft'
        }).addTo(map);
        
        // √©tat de l'application
        let currentMode = 'depot';
        let depot = null;
        let clients = [];
        let stations = [];
        let markers = {
            depot: null,
            clients: [],
            stations: []
        };
        let currentSolutionId = null;
        let eventSource = null;
        
        // gestion du mode de placement
        function setMode(mode) {
            const btn = document.getElementById(`mode-${mode}`);
            const isActive = btn.classList.contains('active');
            
            // d√©s√©lectionner tous les boutons
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            
            // si le bouton √©tait d√©j√† actif, on le d√©s√©lectionne
            if (isActive) {
                currentMode = null;
                updateModeDescription(null);
            } else {
                // sinon, on l'active
                btn.classList.add('active');
                currentMode = mode;
                updateModeDescription(mode);
            }
        }
        
        // mise √† jour de la description selon le mode
        function updateModeDescription(mode) {
            const desc = document.getElementById('mode-description');
            if (!mode) {
                desc.textContent = 'Aucun mode s√©lectionn√©';
                desc.style.color = '#999';
            } else {
                const descriptions = {
                    'depot': 'Cliquez sur la carte pour placer un d√©p√¥t',
                    'client': 'Cliquez sur la carte pour ajouter un client',
                    'station': 'Cliquez sur la carte pour ajouter une station de recharge'
                };
                desc.textContent = descriptions[mode];
                desc.style.color = '#666';
            }
        }
        
        // descriptions des modes
        const modeDescriptions = {
            'rapide': 'Trouve rapidement une solution basique',
            'normal': '√âquilibre vitesse et qualit√© pour la plupart des cas',
            'exploratoire': 'Recherche la meilleure solution possible (plus long)'
        };
        
        // mettre √† jour la description du mode de raisonnement
        function updateModeRaisonnementDescription() {
            const select = document.getElementById('mode-raisonnement');
            const mode = select.value;
            select.title = modeDescriptions[mode] || modeDescriptions['normal'];
        }
        
        // recherche d'adresse et placement
        async function searchAddress() {
            if (!currentMode) {
                document.getElementById('address-status').textContent = 'Veuillez d\'abord s√©lectionner un mode';
                document.getElementById('address-status').style.color = '#f44336';
                return;
            }
            
            const address = document.getElementById('address-search').value.trim();
            if (!address) {
                document.getElementById('address-status').textContent = 'Veuillez entrer une adresse';
                document.getElementById('address-status').style.color = '#f44336';
                return;
            }
            
            document.getElementById('address-status').textContent = 'Recherche en cours...';
            document.getElementById('address-status').style.color = '#666';
            
            try {
                // utiliser Nominatim (OpenStreetMap) pour le g√©ocodage
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`, {
                    headers: {
                        'User-Agent': 'VRP-Optimization-App'
                    }
                });
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    
                    // placer le point comme si on avait cliqu√©
                    placePointAtLocation(lat, lon);
                    
                    // centrer la carte sur le point
                    map.setView([lat, lon], 15);
                    
                    document.getElementById('address-status').textContent = `Point plac√©: ${data[0].display_name}`;
                    document.getElementById('address-status').style.color = '#4CAF50';
                    document.getElementById('address-search').value = '';
                } else {
                    document.getElementById('address-status').textContent = 'Adresse non trouv√©e';
                    document.getElementById('address-status').style.color = '#f44336';
                }
            } catch (error) {
                console.error('Erreur de g√©ocodage:', error);
                document.getElementById('address-status').textContent = 'Erreur lors de la recherche';
                document.getElementById('address-status').style.color = '#f44336';
            }
        }
        
        // fonction pour placer un point √† une location donn√©e
        function placePointAtLocation(lat, lon) {
            if (currentMode === 'depot') {
                if (markers.depot) {
                    map.removeLayer(markers.depot);
                }
                depot = [lat, lon];
                markers.depot = L.marker([lat, lon], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41]
                    })
                }).addTo(map).bindPopup('D√©p√¥t');
                updatePointsList();
            } else if (currentMode === 'client') {
                const marker = L.marker([lat, lon], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41]
                    })
                }).addTo(map).bindPopup(`Client ${clients.length + 1}`);
                clients.push([lat, lon]);
                markers.clients.push(marker);
                updatePointsList();
            } else if (currentMode === 'station') {
                const marker = L.marker([lat, lon], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41]
                    })
                }).addTo(map).bindPopup(`Station ${stations.length + 1}`);
                stations.push([lat, lon]);
                markers.stations.push(marker);
                updatePointsList();
            }
        }
        
        // gestion des clics sur la carte
        map.on('click', function(e) {
            if (!currentMode) {
                return; // aucun mode s√©lectionn√©, ne rien faire
            }
            
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            placePointAtLocation(lat, lon);
        });
        
        
        // fonction pour plier/d√©plier les sous-sections
        function toggleSubsection(header) {
            const subsection = header.parentElement;
            subsection.classList.toggle('collapsed');
        }
        
        // afficher/masquer la colonne autonomie selon le type de v√©hicule
        function toggleAutonomieColumn() {
            const typeVRP = document.getElementById('type-vrp').value;
            const isElectrique = typeVRP === 'vert';
            const autonomieCols = document.querySelectorAll('.autonomie-col');
            
            autonomieCols.forEach(col => {
                col.style.display = isElectrique ? '' : 'none';
            });
        }
        
        // mise √† jour des capacit√©s des v√©hicules
        function updateCapacitesVehicules() {
            const nbVehicules = parseInt(document.getElementById('nb-vehicules').value);
            const typeVRP = document.getElementById('type-vrp').value;
            const isElectrique = typeVRP === 'vert';
            const table = document.querySelector('#capacites-vehicules tbody');
            table.innerHTML = '';
            
            for (let i = 0; i < nbVehicules; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>V√©hicule ${i+1}</td>
                    <td>
                        <input type="number" class="capacite-vehicule" value="50" min="1">
                    </td>
                    <td class="autonomie-col" style="display: ${isElectrique ? '' : 'none'};">
                        <input type="number" class="autonomie-vehicule" value="30" min="1" step="0.1">
                    </td>
                `;
                table.appendChild(row);
            }
        }
        
        // mise √† jour des demandes des clients
        function updateDemandesClients() {
            const container = document.getElementById('demandes-clients');
            
            if (clients.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 11px; text-align: center; padding: 10px;">Placez d\'abord les clients sur la carte</p>';
                return;
            }
            
            let html = `
                <table class="vehicules-table">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Client</th>
                            <th style="width: 70%;">Taille du colis (en unit√©s)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            clients.forEach((c, i) => {
                html += `
                    <tr>
                        <td>Client ${i+1}</td>
                        <td>
                            <input type="number" class="demande-client" data-index="${i}" value="10" min="1">
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // supprimer le d√©p√¥t
        function removeDepot() {
            if (markers.depot) {
                map.removeLayer(markers.depot);
                markers.depot = null;
            }
            depot = null;
            updatePointsList();
        }
        
        // supprimer un client
        function removeClient(index) {
            if (index >= 0 && index < clients.length) {
                if (markers.clients[index]) {
                    map.removeLayer(markers.clients[index]);
                }
                clients.splice(index, 1);
                markers.clients.splice(index, 1);
                
                // mettre √† jour les popups des autres clients
                markers.clients.forEach((marker, i) => {
                    marker.setPopupContent(`Client ${i+1}`);
                });
                
                updatePointsList();
            }
        }
        
        // supprimer une station
        function removeStation(index) {
            if (index >= 0 && index < stations.length) {
                if (markers.stations[index]) {
                    map.removeLayer(markers.stations[index]);
                }
                stations.splice(index, 1);
                markers.stations.splice(index, 1);
                
                // mettre √† jour les popups des autres stations
                markers.stations.forEach((marker, i) => {
                    marker.setPopupContent(`Station ${i+1}`);
                });
                
                updatePointsList();
            }
        }
        
        // mise √† jour de la liste des points
        function updatePointsList() {
            const list = document.getElementById('points-list');
            let html = '';
            
            if (depot) {
                html += `
                    <div class="point-item">
                        <span class="point-item-content">üìç D√©p√¥t: ${depot[0].toFixed(4)}, ${depot[1].toFixed(4)}</span>
                        <button class="point-item-btn" onclick="removeDepot()" title="Supprimer le d√©p√¥t">üóëÔ∏è</button>
                    </div>
                `;
            }
            
            clients.forEach((c, i) => {
                html += `
                    <div class="point-item">
                        <span class="point-item-content">üîµ Client ${i+1}: ${c[0].toFixed(4)}, ${c[1].toFixed(4)}</span>
                        <button class="point-item-btn" onclick="removeClient(${i})" title="Supprimer ce client">üóëÔ∏è</button>
                    </div>
                `;
            });
            
            stations.forEach((s, i) => {
                html += `
                    <div class="point-item">
                        <span class="point-item-content">üü¢ Station ${i+1}: ${s[0].toFixed(4)}, ${s[1].toFixed(4)}</span>
                        <button class="point-item-btn" onclick="removeStation(${i})" title="Supprimer cette station">üóëÔ∏è</button>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<p style="color: #999; font-size: 12px;">Aucun point plac√©</p>';
            }
            
            list.innerHTML = html;
            updateDemandesClients();
        }
        
        // effacer tout
        function clearAll() {
            depot = null;
            clients = [];
            stations = [];
            
            if (markers.depot) {
                map.removeLayer(markers.depot);
                markers.depot = null;
            }
            
            markers.clients.forEach(m => map.removeLayer(m));
            markers.clients = [];
            
            markers.stations.forEach(m => map.removeLayer(m));
            markers.stations = [];
            
            // effacer les tourn√©es
            if (window.tourneeLayers) {
                window.tourneeLayers.forEach(layer => map.removeLayer(layer));
                window.tourneeLayers = [];
            }
            
            updatePointsList();
            updateDemandesClients();
            document.getElementById('results-section').style.display = 'none';
            
            // restaurer le bouton si en mode progression
            const solveBtn = document.getElementById('solve-btn');
            if (solveBtn.classList.contains('progress-mode')) {
                solveBtn.classList.remove('progress-mode');
                solveBtn.disabled = false;
                solveBtn.innerHTML = 'R√©soudre';
            }
            
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }
        
        // r√©soudre le VRP
        async function solveVRP() {
            if (!depot || clients.length === 0) {
                alert('Veuillez placer au moins un d√©p√¥t et un client');
                return;
            }
            
            const typeVRP = document.getElementById('type-vrp').value;
            if (typeVRP === 'vert' && stations.length === 0) {
                alert('Pour le VRP vert, veuillez placer au moins une station de recharge');
                return;
            }
            
            // replier la sidebar si elle est ouverte
            const sidebar = document.getElementById('sidebar');
            if (!sidebar.classList.contains('collapsed')) {
                sidebar.classList.add('collapsed');
                document.body.classList.add('sidebar-collapsed');
                const toggle = document.getElementById('sidebar-toggle');
                toggle.textContent = '‚ò∞';
                // redimensionner la carte apr√®s l'animation
                setTimeout(() => {
                    map.invalidateSize();
                }, 300);
            }
            
            // d√©s√©lectionner les boutons de mode de placement
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            currentMode = null;
            updateModeDescription(null);
            
            // transformer le bouton en mode progression
            const solveBtn = document.getElementById('solve-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            // sauvegarder la taille initiale du bouton
            const initialWidth = solveBtn.offsetWidth;
            const initialHeight = solveBtn.offsetHeight;
            
            solveBtn.disabled = true;
            solveBtn.classList.add('progress-mode');
            
            // appliquer la taille initiale
            solveBtn.style.width = initialWidth + 'px';
            solveBtn.style.height = initialHeight + 'px';
            
            solveBtn.innerHTML = '<div class="progress-fill-btn" id="progress-fill-btn"></div><div class="progress-text-btn" id="progress-text-btn">R√©solution en cours...</div>';
            cancelBtn.style.display = 'block';
            
            // effacer les anciennes tourn√©es
            if (window.tourneeLayers) {
                window.tourneeLayers.forEach(layer => map.removeLayer(layer));
            }
            window.tourneeLayers = [];
            
            // masquer les r√©sultats
            document.getElementById('results-section').style.display = 'none';
            
            // collecter les capacit√©s des v√©hicules
            const capacitesInputs = document.querySelectorAll('.capacite-vehicule');
            const capacites = Array.from(capacitesInputs).map(input => parseInt(input.value) || 50);
            
            // collecter les autonomies des v√©hicules (si √©lectrique)
            let autonomies = null;
            if (typeVRP === 'vert') {
                const autonomiesInputs = document.querySelectorAll('.autonomie-vehicule');
                autonomies = Array.from(autonomiesInputs).map(input => parseFloat(input.value) || 30.0);
            }
            
            // collecter les demandes des clients
            const demandesInputs = document.querySelectorAll('.demande-client');
            const demandes = Array.from(demandesInputs).map(input => parseInt(input.value) || 10);
            
            // calculer la limite de temps selon le mode de raisonnement
            const modeRaisonnement = document.getElementById('mode-raisonnement').value;
            let limite_temps = 15; // par d√©faut: normal
            if (modeRaisonnement === 'rapide') {
                limite_temps = 3;
            } else if (modeRaisonnement === 'normal') {
                limite_temps = 15;
            } else if (modeRaisonnement === 'exploratoire') {
                limite_temps = 60;
            }
            
            const data = {
                depot: depot,
                clients: clients,
                stations: stations,
                nombre_vehicules: parseInt(document.getElementById('nb-vehicules').value),
                capacites_vehicules: capacites,
                demandes: demandes,
                limite_temps: limite_temps,
                type: typeVRP
            };
            
            // ajouter les autonomies si v√©hicules √©lectriques
            if (autonomies) {
                data.autonomies_vehicules = autonomies;
            }
            
            try {
                const response = await fetch('/api/solve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                currentSolutionId = result.solution_id;
                
                // d√©marrer le stream de mises √† jour
                startSolutionStream(currentSolutionId);
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la r√©solution: ' + error.message);
                const solveBtn = document.getElementById('solve-btn');
                const cancelBtn = document.getElementById('cancel-btn');
                solveBtn.classList.remove('progress-mode');
                solveBtn.style.width = '';
                solveBtn.style.height = '';
                solveBtn.disabled = false;
                solveBtn.innerHTML = 'R√©soudre';
                cancelBtn.style.display = 'none';
            }
        }
        
        // annuler la r√©solution en cours
        function cancelSolution() {
            // fermer le stream de solutions
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            // r√©initialiser le bouton r√©soudre
            const solveBtn = document.getElementById('solve-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            solveBtn.classList.remove('progress-mode');
            solveBtn.style.width = '';
            solveBtn.style.height = '';
            solveBtn.disabled = false;
            solveBtn.innerHTML = 'R√©soudre';
            cancelBtn.style.display = 'none';
            
            // masquer les r√©sultats
            document.getElementById('results-section').style.display = 'none';
            
            // r√©initialiser l'id de solution
            currentSolutionId = null;
        }
        
        // d√©marrer le stream de solutions
        function startSolutionStream(solutionId) {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(`/api/solution/${solutionId}/stream`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateProgress(data);
            };
            
            eventSource.onerror = function(error) {
                console.error('Erreur SSE:', error);
                eventSource.close();
            };
        }
        
        // mettre √† jour la progression
        function updateProgress(data) {
            const progressFill = document.getElementById('progress-fill-btn');
            const progressText = document.getElementById('progress-text-btn');
            const solveBtn = document.getElementById('solve-btn');
            
            if (data.statut === 'en_cours') {
                const progression = data.progression || 0;
                progressFill.style.width = progression + '%';
                
                if (data.distance) {
                    progressText.textContent = `Distance: ${data.distance.toFixed(2)} km`;
                } else {
                    progressText.textContent = 'R√©solution en cours...';
                }
                
                // afficher les tourn√©es partielles
                if (data.tournees && data.tournees.length > 0) {
                    displayTournees(data.tournees, data.statut === 'en_cours');
                }
            } else if (data.statut === 'optimal' || data.statut === 'feasible') {
                progressFill.style.width = '100%';
                const statutFr = translateStatut(data.statut);
                progressText.textContent = `Termin√© - ${statutFr}`;
                progressText.style.color = '#fff';
                progressText.style.fontWeight = 'bold';
                
                // afficher les r√©sultats finaux
                displayResults(data);
                displayTournees(data.tournees, false);
                
                // restaurer le bouton normal
                const cancelBtn = document.getElementById('cancel-btn');
                setTimeout(() => {
                    solveBtn.classList.remove('progress-mode');
                    solveBtn.style.width = '';
                    solveBtn.style.height = '';
                    solveBtn.disabled = false;
                    solveBtn.innerHTML = 'R√©soudre';
                    cancelBtn.style.display = 'none';
                }, 2000);
                
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            } else if (data.statut === 'infeasible' || data.statut === 'erreur') {
                const statutFr = translateStatut(data.statut);
                progressText.textContent = `Erreur: ${statutFr}`;
                progressText.style.color = '#fff';
                progressText.style.fontWeight = 'bold';
                
                // restaurer le bouton normal
                const cancelBtn = document.getElementById('cancel-btn');
                setTimeout(() => {
                    solveBtn.classList.remove('progress-mode');
                    solveBtn.style.width = '';
                    solveBtn.style.height = '';
                    solveBtn.disabled = false;
                    solveBtn.innerHTML = 'R√©soudre';
                    cancelBtn.style.display = 'none';
                }, 2000);
                
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            }
        }
        
        // afficher les tourn√©es sur la carte
        function displayTournees(tournees, isPartial) {
            // effacer les anciennes tourn√©es
            if (window.tourneeLayers) {
                window.tourneeLayers.forEach(layer => map.removeLayer(layer));
            }
            window.tourneeLayers = [];
            
            const colors = ['#FF0000', '#0000FF', '#00FF00', '#FF00FF', '#FFFF00', '#00FFFF', '#FFA500', '#800080'];
            
            tournees.forEach((tournee, idx) => {
                if (tournee.length < 2) return;
                
                const points = [];
                tournee.forEach(nodeIdx => {
                    if (nodeIdx === 0 && depot) {
                        points.push([depot[0], depot[1]]);
                    } else if (nodeIdx > 0 && nodeIdx <= clients.length) {
                        points.push([clients[nodeIdx - 1][0], clients[nodeIdx - 1][1]]);
                    } else if (nodeIdx > clients.length && stations.length > 0) {
                        const stationIdx = nodeIdx - 1 - clients.length;
                        if (stationIdx < stations.length) {
                            points.push([stations[stationIdx][0], stations[stationIdx][1]]);
                        }
                    }
                });
                
                if (points.length >= 2) {
                    const color = colors[idx % colors.length];
                    const polyline = L.polyline(points, {
                        color: color,
                        weight: 4,
                        opacity: isPartial ? 0.5 : 0.8
                    }).addTo(map);
                    
                    polyline.bindPopup(`V√©hicule ${idx + 1}`);
                    window.tourneeLayers.push(polyline);
                }
            });
        }
        
        // traduire le statut en fran√ßais
        function translateStatut(statut) {
            const traductions = {
                'optimal': 'Optimal',
                'feasible': 'R√©alisable',
                'infeasible': 'Irr√©alisable',
                'en_cours': 'En cours',
                'erreur': 'Erreur',
                'attente': 'En attente',
                'non_trouve': 'Non trouv√©'
            };
            return traductions[statut] || statut;
        }
        
        // afficher les r√©sultats
        function displayResults(data) {
            document.getElementById('results-section').style.display = 'block';
            const statutFr = translateStatut(data.statut);
            document.getElementById('result-statut').textContent = `Statut : ${statutFr}`;
            document.getElementById('result-distance').textContent = `Distance totale : ${data.distance ? data.distance.toFixed(2) + ' km' : 'N/A'}`;
            document.getElementById('result-vehicules').textContent = `V√©hicules utilis√©s : ${data.nombre_vehicules || data.tournees ? data.tournees.length : 0}`;
        }
        
        // initialisation
        window.tourneeLayers = [];
        updateModeDescription('depot'); // initialiser la description avec le mode par d√©faut
        updateModeRaisonnementDescription(); // initialiser la description du mode de raisonnement
        
        // initialiser la sidebar comme pli√©e
        document.body.classList.add('sidebar-collapsed');
        
        // initialiser l'affichage de la colonne autonomie
        toggleAutonomieColumn();
    </script>
</body>
</html>

